<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"â€º
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Lab 7 Homework</title>

        <style>
            html, body, #viewDiv{
                padding: 0;
                margin: 0;
                height: 100%;
                width: 100%;
                }

            #optionsDiv {
              background-color: dimgray;
              color: white;
              padding: 18px; width: 350px;
            }

            .esri-popup .esri-popup-header .esri-title {
                font-size: 18px;
                font-weight: bolder;
            }
            .esri-popup .esri-popup-body .esri-popup-content {
                font-size: 14px;
            }

        </style>

      <link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/themes/light/main.css"/>
      <script src="https://js.arcgis.com/4.21/"></script>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/TileLayer",
        "esri/layers/MapImageLayer",
        "esri/layers/GraphicsLayer",
        "esri/tasks/QueryTask",
        "esri/tasks/support/Query",
        "dojo/_base/array",
        "dojo/dom",
        "dojo/on",
        "dojo/domReady!"
      ],

      function(Map, MapView, TileLayer, MapImageLayer, GraphicsLayer, QueryTask, Query, arrayUtils, dom, on){

       //  var TreeLayer = new TileLayer({
       //   url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Boston_Trees_with_Height_WFL1/FeatureServer",
       // });

        var TreeRenderer = {
              type: "simple",
              symbol: {
                  type: "simple-marker",
                  size: 4,
                  color: "green",
                  style: "circle",
                  outline: {
                      width: 1,
                      color: "green"}
           },
            label: "Trees"
          };

          var TreeLayer = new MapImageLayer({
            url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Boston_Trees_with_Height_WFL1/FeatureServer",
             sublayers: [
                 {
                      id: 0,
                      renderer: TreeRenderer,
                      opacity: 0.4
                   }
                ]
          });


        var map = new Map({
          basemap: "streets",
          layers: [TreeLayer]
        });

        var view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 11,
          center: [-71.0589, 42.3601]
          });


        var popUrl = "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/ArcGIS/rest/services/Boston_Trees_with_Height_WFL1/FeatureServer/0";

        var popupTemplate = {
          title: "{OBJECTID}",
          fieldInfos: [{
            fieldName: "TYPE",
            label: "Type",
          }, {
            fieldName: "height",
            label: "Height",
            format: {
              places: 0,
              digitSeparator: true
            }
          }],
          content:
            "<b>Type:</b> {TYPE}" +
            "<br><b>Foot Elevation:</b> {foot_el} " +
            "<br><b>Height:</b> {height} " +
            "<br><b>Top Elevation:</b> {top_el} " +
            "<br><b>Z:</b> {Z} "
        };

        var resultsLayer = new GraphicsLayer();

        var qTask = new QueryTask({
          url: popUrl
        });

        var params = new Query({
          returnGeometry: true,
          outFields: ["*"]
        });

        view.when(function() {
          view.ui.add("optionsDiv", "bottom-right");
          on(dom.byId("doBtn"), "click", doQuery);
        });

        var attributeName = dom.byId("attSelect");
        var expressionSign = dom.byId("signSelect");
        var value = dom.byId("valSelect");


        function doQuery() {
          resultsLayer.removeAll();
          params.where = attributeName.value + expressionSign.value + value.value;
          qTask.execute(params)
            .then(getResults)
            .catch(promiseRejected);
        }

        function getResults(response) {
          var popResults = arrayUtils.map(response.features, function(
            feature) {
            feature.popupTemplate = popupTemplate;
            return feature;
          });

          resultsLayer.addMany(popResults);

          view.goTo(popResults).then(function() {
            view.popup.open({
              features: popResults,
              featureMenuOpen: true,
              updateLocationEnabled: true
            });
          });

          dom.byId("printResults").innerHTML = popResults.length +
            "results found!";
        }

        function promiseRejected(error) {
          console.error("Promise rejected: ", error.message);
        }

    });
    </script>
</head>

<body>
  <div id="viewDiv"></div>

  <div class="esri-widget" id="optionsDiv">
      <h2>Boston Trees</h2>
      <select class="esri-widget" id="attSelect">
          <option value="height">Height</option>
      </select>
      <select class="esri-widget" id="signSelect">
          <option value=">">is greater than</option>
          <option value="<">is less than</option>
      </select>

      <select class="esri-widget" id="valSelect">
          <option value="10">10</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
      </select>
      <br>
      <br>
      <button class="esri-widget" id="doBtn">Do Query</button>
      <br>
      <p><span id="orintResults"></span></p>
  </div>

</body>

</html>
